<div>
   <p id="mode"><b>Mode </b>: nothing</p>
   <p id="indeximagecanvas"><b>Images: </b> 0 / 0</p>
   <canvas id="canvas" width="800" height="600" style="cursor:crosshair;"></canvas>
</div>

<script>

$('#canvas').css('background-color', 'rgba(127, 140, 141, 0.2)');

var canvas = document.getElementById("canvas");
canvas.started = false;
canvas.width = 800;
canvas.height = 600;
canvas.state = "nothing";
canvas.scaleFactor = 1.05;
canvas.pointSize = momacs_config.size_point + momacs_config.size_hover;
canvas.lastX=canvas.width/2;
canvas.lastY=canvas.height/2;
canvas.currentScale = 1;
canvas.dragStart = null;
canvas.imagePath = "";
canvas.typeofcurve = "close";
canvas.typeevent = "";

canvas.idPoint = 0;

canvas.indexPoint2D = 0;
canvas.arrayPoint2D = [];

canvas.indexSegment2D = 0;
canvas.arraySegment2D = [];
canvas.firstSegment = true;
canvas.newA = null;
canvas.newB = null;

canvas.curve = null;
canvas.newCA = null;
canvas.newCB = null;

canvas.draggedPoint = null;

canvas.pointsPartition = [];
canvas.segmentsPartition = [];
canvas.curvesPartition = [];

canvas.sizePointsPartition = 0;
canvas.sizeSegmentsPartition = 0;
canvas.sizeCurvesPartition = 0;

canvas.currentPointPartiton = 0;
canvas.currentSegmentPartiton = 0;
canvas.currentCurvePartiton = 0;

var ctx = null;
var ima1 = null;

window.onload = function(){ 
  
document.body.style.mozUserSelect = document.body.style.webkitUserSelect = document.body.style.userSelect = 'none';
          
ctx = canvas.getContext('2d');
trackTransforms(ctx);
canvas.curve = new Curve2D(0);

canvas.pointsPartition[0] = new Partition(0);
canvas.segmentsPartition[0] = new Partition(0);
canvas.curvesPartition[0] = new Curve2D(0);

//===========================================================================

canvas.addEventListener('click',function(evt)
{
  if(canvas.started) {
        var pt = this.getPosition(evt);
        if(canvas.state == "drawPoint") {
            this.drawCoordinates(pt.x,pt.y);
            var point = new Point2D(this.idPoint, pt.x, pt.y);
            this.arrayPoint2D.push(point);
            this.indexPoint2D++;
            this.idPoint++;
        } else if(canvas.state == "drawSegment") {
            this.drawCoordinates(pt.x,pt.y);
            var p = new Point2D(this.idPoint, pt.x, pt.y);
            this.idPoint++;
            if(this.firstSegment) {
               if(this.indexSegment2D == 0) {
                  var s = new Segment2D(this.indexSegment2D, p, null);
                  this.arraySegment2D.push(s);
                  this.indexSegment2D++;
               } else {
                  this.arraySegment2D[this.indexSegment2D - 1].p2 = p;
                  this.drawLine(this.arraySegment2D[this.indexSegment2D - 1].p1, p);
                  this.firstSegment = false;
               }
            } else {
              var lastp = this.arraySegment2D[this.indexSegment2D - 1].p2;
              var s = new Segment2D(this.indexSegment2D, lastp, p);
              this.drawLine(lastp, p);
              this.arraySegment2D.push(s);
              this.indexSegment2D++;
            }
        } else if(canvas.state == "drawCurve") {
            var p = new Point2D(this.idPoint, pt.x, pt.y);
            this.idPoint++;
            this.curve.points.push(p);
            this.curve.size++;
            this.redraw();
        } else if(canvas.state == "deletePoint") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            for (var i = 0; i < this.indexPoint2D; i++) {
                var d = this.distance(point, this.arrayPoint2D[i]);
                if(d <= this.pointSize) {
                   indexToDelete = i;
                   break;
                }
            }
            if(indexToDelete != null) { //we found à point to delete
                var newPoints = [];
                for (var i = 0; i < this.indexPoint2D; i++) {
                  if(i != indexToDelete){
                     newPoints.push(this.arrayPoint2D[i]);
                  }
                }
                this.arrayPoint2D = newPoints;
                this.indexPoint2D--;
            }
            this.redraw();
        } else if(canvas.state == "deletePointSegment") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            var pToDelete = null;
            for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   indexToDelete = i;
                   pToDelete = 1;
                   break;
                } else if(d2 <= this.pointSize) {
                   indexToDelete = i;
                   pToDelete = 2;
                   break;
                }
            }
            if(indexToDelete != null) { //we found à point to delete
              
            
               var newSegments = [];
               if(indexToDelete == 0 && pToDelete == 1) { //cas particulier de 1er
                  for (var i = 1; i < this.indexSegment2D; i++) {
                    newSegments.push(this.arraySegment2D[i]);
                  }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               } else if(indexToDelete == this.indexSegment2D - 1 && pToDelete == 2) { //cas particulier du dernier
                    for (var i = 0; i < this.indexSegment2D - 1; i++) {
                        newSegments.push(this.arraySegment2D[i]);
                    }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               } else { 
                  for (var i = 0; i < this.indexSegment2D; i++) {
                    if(indexToDelete == i) {
                        //normalement c toujour p2
                         var old = this.arraySegment2D[i];
                         var old2 = this.arraySegment2D[i+1];
                         var p1 = new Point2D(old.p1.id, old.p1.x, old.p1.y);
                         var p2 = new Point2D(old2.p2.id, old2.p2.x, old2.p2.y);
                         var newss = new Segment2D(old.id, p1, p2);
                         newSegments.push(newss);
                    } else {
                       if(indexToDelete+1 == i) {
                          //nothing to do                         
                       } else {
                          newSegments.push(this.arraySegment2D[i]);
                       }
                    }
                  }
                  this.arraySegment2D = newSegments;
                  this.indexSegment2D--;
               }
            }
            
            if(this.indexSegment2D == 0) {
              canvas.firstSegment = true;
            }
            
            this.redraw();
        } else if(canvas.state == "deletePointCurve") {
            var point = new Point2D(0, pt.x, pt.y);
            var indexToDelete = null;
            for (var i = 0; i < this.curve.size; i++) {
                var d = this.distance(point, this.curve.points[i]);
                if(d <= this.pointSize) {
                   indexToDelete = i;
                   break;
                }
            }
            
             if(indexToDelete != null) {
                 
                  var newPoints = [];
          
                  for (var i = 0; i < this.curve.size; i++) {
                      if(i != indexToDelete){
                          newPoints.push(this.curve.points[i]);
                      }
                  }
                  this.curve.points = newPoints;
                  this.curve.size--;
                
            }
            
            
          this.redraw();
        } else if(canvas.state == "addPointOnSegment") {
          var point = new Point2D(this.idPoint, pt.x, pt.y);
            if(canvas.newA == null) {
              for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   canvas.newA = this.arraySegment2D[i].p1;
                   break;
                } else if(d2 <= this.pointSize) {
                   canvas.newA = this.arraySegment2D[i].p2;
                   break;
                }
              }
            } else if(canvas.newB == null) {
              for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   canvas.newB = this.arraySegment2D[i].p1;
                   break;
                } else if(d2 <= this.pointSize) {
                   canvas.newB = this.arraySegment2D[i].p2;
                   break;
                }
              }
              
              if(canvas.newB == null) {
                canvas.newB = point; //segment with new point
                this.idPoint++;
              }
            
              var s = new Segment2D(this.indexSegment2D, canvas.newA, canvas.newB);
              this.arraySegment2D.push(s);
              this.indexSegment2D++;
              this.redraw();
              canvas.newA = null;
              canvas.newB = null;
             
            }
        } else if(canvas.state == "addPointOnCurve") {
           var point = new Point2D(this.idPoint, pt.x, pt.y);
           if(canvas.newCA == null) {
             
            for (var i = 0; i < this.curve.size; i++) {
                var d = this.distance(point, this.curve.points[i]);
                if(d <= this.pointSize) {
                   canvas.newCA = this.curve.points[i];
                   break;
                }
            }
             
             
           } else if(canvas.newCB == null) {
                for (var i = 0; i < this.curve.size; i++) {
                    var d = this.distance(point, this.curve.points[i]);
                    if(d <= this.pointSize) {
                       canvas.newCB = this.curve.points[i];
                       break;
                    }
                }
                if(canvas.newCB != null) { //we found other point
                    var newPoint = [];
                    
                    //for find max in tree
                    var indexA = 0;
                    var indexB = 0;
                    for (var i = 0; i < this.curve.size; i++) {
                      if(this.curve.points[i].id == canvas.newCA.id) {
                        indexA = i;
                      }
                      
                      if(this.curve.points[i].id == canvas.newCB.id) {
                        indexB = i;
                      }
                    }
                     
                    var rid = this.curve.points[Math.max(indexA, indexB)].id;
                    
                    var nx = (canvas.newCA.x + canvas.newCB.x) / 2;
                    var ny = (canvas.newCA.y + canvas.newCB.y) / 2;
                    var p = new Point2D(this.idPoint, nx, ny);
                    var lastid = this.curve.points[this.curve.size - 1].id;
                    var firstid = this.curve.points[0].id;
                    
                    if(canvas.newCA.id == lastid && canvas.newCB.id == firstid) {
                        for (var i = 0; i < this.curve.size; i++) {
                           newPoint.push(this.curve.points[i]);
                        }
                       newPoint.push(p); 
                       this.idPoint++;
                     } else if (canvas.newCA.id == firstid && canvas.newCB.id == lastid) {
                        for (var i = 0; i < this.curve.size; i++) {
                           newPoint.push(this.curve.points[i]);
                        }
                       newPoint.push(p); 
                       this.idPoint++;
                     } else {
                      for (var i = 0; i < this.curve.size; i++) {
      
                        if(this.curve.points[i].id == rid) {
          
                               newPoint.push(p); //on l'add juste avant
                               this.idPoint++;
                                newPoint.push(this.curve.points[i]);
                        } else {
                          newPoint.push(this.curve.points[i]);
                        }
                    }
                      
                    }
                    this.curve.points = newPoint;
                    this.curve.size++;
                    this.redraw();
                    canvas.newCA = null;
                    canvas.newCB = null;
                }
           }
        }
  
  }
},false);

//===========================================================================

canvas.addEventListener('mousedown',function(evt)
{
  if(canvas.started) {
    var pt = this.getPosition(evt);
    if(canvas.state == "move") {
        this.dragStart = pt;
    }
    
    if(this.state == "movePoint") {
        var point = new Point2D(0, pt.x, pt.y);
        for (var i = 0; i < this.indexPoint2D; i++) {
            var d = this.distance(point, this.arrayPoint2D[i]);
            if(d <= this.pointSize) {
                 this.draggedPoint = this.arrayPoint2D[i];
                 break;
            }
        }
    }
    
    if(this.state == "movePointSegment") {
      var point = new Point2D(0, pt.x, pt.y);
      for (var i = 0; i < this.indexSegment2D; i++) {
                var d1 = this.distance(point, this.arraySegment2D[i].p1);
                var d2 = this.distance(point, this.arraySegment2D[i].p2);
                if(d1 <= this.pointSize) {
                   this.draggedPoint = this.arraySegment2D[i].p1;
                   break;
                } else if(d2 <= this.pointSize) {
                   this.draggedPoint = this.arraySegment2D[i].p2;
                   break;
                }
      }
    }
    
    if(this.state == "movePointCurve") {
        var point = new Point2D(0, pt.x, pt.y);
        for (var i = 0; i < this.curve.size; i++) {
               var d = this.distance(point, this.curve.points[i]);
               if(d <= this.pointSize) {
                 this.draggedPoint = this.curve.points[i];
                 break;
              }
          }
    }
    
  }
},false);

//===========================================================================

canvas.addEventListener('mouseup',function(evt)
{
  if(this.started) {
    if(this.state == "move") {
        this.dragStart = null;
    }
    
    if(this.state == "movePoint" || this.state == "movePointSegment" || this.state == "movePointCurve") {
        this.draggedPoint = null;
    }
  }
},false);

//===========================================================================

canvas.addEventListener('mouseleave',function(evt)
{
  if(this.started) {
    if(this.state == "move") {
        this.dragStart = null;
    }
    
    if(this.state == "movePoint" || this.state == "movePointSegment" || this.state == "movePointCurve") {
        this.draggedPoint = null;
    }
  }
},false);

//===========================================================================

canvas.addEventListener('mousemove',function(evt){
  
    if(canvas.started) {
        var pt = this.getPosition(evt);
        if(canvas.state == "move") {
              if (this.dragStart){
                
                ctx.translate(pt.x-this.dragStart.x,pt.y-this.dragStart.y);
                this.redraw();
              }
        } else  if(this.state == "movePoint" || this.state == "movePointSegment"|| this.state == "movePointCurve") {
           if(this.draggedPoint) {
              this.draggedPoint.x = pt.x;
              this.draggedPoint.y = pt.y;
              this.redraw();
           }
        } else  {
          
          this.redraw();
          
        }
        
        
    }
},false);

//===========================================================================

canvas.distance = function (p1, p2) {
  return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
}

//===========================================================================

canvas.distanceSegment = function(s, p) {
    var a = s.p1;
    var b = s.p2;
    var n = this.minus(b, a);
    var pa = this.minus(a, p);
    var c = this.mult(n , (this.dot( n, pa ) / this.dot( n, n )));
    var d = this.minus(pa - c);
    return d;
}

//===========================================================================

canvas.getPosition = function(evt) {
  this.lastX = evt.offsetX || (evt.pageX - this.offsetLeft);
  this.lastY = evt.offsetY || (evt.pageY - this.offsetTop);
  var pt = ctx.transformedPoint(this.lastX,this.lastY);
  return pt;
}

//===========================================================================

canvas.drawCoordinates = function (x,y) {
    ctx.fillStyle = momacs_config.color_point; // Red color
    ctx.beginPath(); //Start path
    ctx.arc(x, y, momacs_config.size_point, 0, Math.PI * 2, true); // Draw a point using the arc function of the canvas with a point structure.
    ctx.fill(); // Close the path and fill.
}

//===========================================================================

canvas.drawText = function(value, x, y) {
  ctx.fillStyle = momacs_config.color_text; // dark blue color
    ctx.beginPath(); //Start path
    ctx.font = momacs_config.size_text+"px Arial";
    ctx.fillText(value, x+5, y);
    ctx.fill(); // Close the path and fill.
}

//===========================================================================

canvas.drawPoint = function(value, x, y) {
  this.drawCoordinates(x, y);
  this.drawText(value, x, y);
}

//===========================================================================

canvas.drawLine = function (p1, p2) {
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.strokeStyle = momacs_config.color_segment;
    ctx.lineWidth = momacs_config.size_segment;
    ctx.stroke();
    ctx.fill();
}

//===========================================================================

canvas.drawBezier = function (points) {
   if(points.length == 0) {
     return;
   }
   
   var pts = [];
  
   var j = 0;
   for (var i = 0; i < points.length; i++) {
     pts[j] = points[i].x;
     pts[j+1] = points[i].y;
     j += 2;
     this.drawCoordinates(points[i].x,points[i].y);
     this.drawText("C0-"+i, points[i].x, points[i].y);
   }

  ctx.beginPath();
  ctx.moveTo(pts[0], pts[1]);
	this.curve.allpts = ctx.curve(pts, 0.5, 20, (this.typeofcurve == "close"));
	ctx.lineWidth = momacs_config.size_curve;
	ctx.strokeStyle = momacs_config.color_curve;
	ctx.stroke();
}

//===========================================================================

canvas.gradient = function (a, b) 
{
    return (b.y-a.y)/(b.x-a.x);
}

//===========================================================================

canvas.dot = function (a, b)
{
    return a.x * b.x + a.y * b.y;
}

//===========================================================================

canvas.minus = function (a, b)
{
  var v = new Point2D(0, 0, 0);
  v.x = a.x - b.x;
  v.y = a.y - b.y;
  return v;
}

//===========================================================================

canvas.mult = function (a, v) 
{
  var v = new Point2D(0, 0, 0);
  v.x = a.x * v;
  v.y = a.y * v;
  return v;
}

//===========================================================================

canvas.zoom = function(clicks){
    if(canvas.started ) {
        var pt = ctx.transformedPoint(this.lastX,this.lastY);
        ctx.translate(pt.x,pt.y);
        var factor = Math.pow(this.scaleFactor,clicks);
        this.currentScale *= factor;
        ctx.scale(factor,factor);
        ctx.translate(-pt.x,-pt.y);
        this.redraw();
    }
}

//===========================================================================

var handleScroll = function(evt){
  if(canvas.started ) {
          var delta = evt.wheelDelta ? evt.wheelDelta/40 : evt.detail ? -evt.detail : 0;
          if (delta) canvas.zoom(delta);
          return evt.preventDefault() && false;
  }
};

//===========================================================================
      
$('input[type=radio][name=typeCurve]').change(function () {
    canvas.typeofcurve = this.value;
    if(canvas.started ) {
        canvas.redraw();
    }
});
    
//===========================================================================    
      
canvas.addEventListener('DOMMouseScroll',handleScroll,false);

//===========================================================================

canvas.addEventListener('mousewheel',handleScroll,false);

//===========================================================================

canvas.redraw = function (){

          // Clear the entire canvas
          var p1 = ctx.transformedPoint(0,0);
          var p2 = ctx.transformedPoint(this.width,this.height);
          ctx.clearRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y);

          ctx.save();
          ctx.setTransform(1,0,0,1,0,0);
          ctx.clearRect(0,0,this.width,this.height);
          ctx.restore();

          ctx.drawImage(ima1,0,0);
        
          for (var i = 0; i < this.indexPoint2D; i++) {
              this.drawPoint("P0-"+i , this.arrayPoint2D[i].x, this.arrayPoint2D[i].y);
          }
          
          var index = 0;
          
          for (var i = 0; i < this.indexSegment2D; i++) {
              var p1 = this.arraySegment2D[i].p1;
              var p2 = this.arraySegment2D[i].p2;
              
              if(p2) {
                 this.drawCoordinates(p1.x, p1.y);
                 this.drawCoordinates(p2.x, p2.y);
                 this.drawLine(p1, p2);
                 
                 if(i == 0) {
                   this.drawText("S0-"+index , p1.x, p1.y);
                   index++
                 } 
                   
                   if(i == this.indexSegment2D - 1) { //last element
                     if(p2.id != this.arraySegment2D[0].p1.id) {
                       this.drawText("S0-"+index , p2.x, p2.y);
                       index++;
                     }
                   } else {
                       this.drawText("S0-"+index , p2.x, p2.y);
                       index++;
                   }
                 
                 
              } else {
                this.drawCoordinates(p1.x, p1.y);
                this.drawText("S0-"+index , p1.x, p1.y);
                index++;
              }
          }
          
          this.drawBezier(this.curve.points);
}

//===========================================================================

var eventClickButtonChange = function(name, mode, action) {
  $(name).removeClass("btn-danger");
  $(name).addClass("btn-success");
  if(mode == action) {
    $(name).addClass("btn-danger");
    $(name).removeClass("btn-success"); 
  }
}

//===========================================================================

canvas.changeMode = function(mode) {
   $("#mode").html("<b>Mode </b>: " + mode);
   eventClickButtonChange("#buttonMoveImage", mode, "move");
   eventClickButtonChange("#buttonDrawPoint", mode, "drawPoint");
   eventClickButtonChange("#buttonDrawSegment", mode, "drawSegment");
   eventClickButtonChange("#buttonDrawCurve", mode, "drawCurve");
   eventClickButtonChange("#buttonDeletePoint", mode, "deletePoint");
   eventClickButtonChange("#buttonDeletePointSegment", mode, "deletePointSegment");
   eventClickButtonChange("#buttonDeletePointCurve", mode, "deletePointCurve");
   eventClickButtonChange("#buttonMovePoint", mode, "movePoint");
   eventClickButtonChange("#buttonMovePointSegment", mode, "movePointSegment");
   eventClickButtonChange("#buttonMovePointCurve", mode, "movePointCurve");
   eventClickButtonChange("#buttonAddPointOnSegment", mode, "addPointOnSegment");
   eventClickButtonChange("#buttonAddPointOnCurve", mode, "addPointOnCurve");
}

//===========================================================================

var actionChangeMode = function(mode) {
  if(canvas.started) {
    if(canvas.state == mode) {
      canvas.state = "nothing";
    } else {
      canvas.state = mode;
    }
    canvas.changeMode(canvas.state);
  }
}

//===========================================================================

$("#buttonMoveImage").click(function(e){
    actionChangeMode("move");
});

//===========================================================================

$("#buttonDrawPoint").click(function(e){
    actionChangeMode("drawPoint");
});

//===========================================================================

$("#buttonDrawSegment").click(function(e){
    actionChangeMode("drawSegment");
});

//===========================================================================

$("#buttonDrawCurve").click(function(e){
    actionChangeMode("drawCurve");
});


//===========================================================================

$("#buttonDeletePoint").click(function(e){ 
    actionChangeMode("deletePoint");
});

//===========================================================================

$("#buttonDeletePointSegment").click(function(e){ 
    actionChangeMode("deletePointSegment");
});

//===========================================================================

$("#buttonDeletePointCurve").click(function(e){ 
    actionChangeMode("deletePointCurve");
});

//===========================================================================

$("#buttonMovePoint").click(function(e){ 
    actionChangeMode("movePoint");
});

//===========================================================================

$("#buttonMovePointSegment").click(function(e){ 
    actionChangeMode("movePointSegment");
});

//===========================================================================

$("#buttonMovePointCurve").click(function(e){ 
    actionChangeMode("movePointCurve");
});

//===========================================================================

$("#buttonAddPointOnSegment").click(function(e){ 
    actionChangeMode("addPointOnSegment");
});

//===========================================================================

$("#buttonAddPointOnCurve").click(function(e){ 
    actionChangeMode("addPointOnCurve");
});

//===========================================================================

$("#deleteLastElement").click(function(e){ 
  
    if(canvas.started) {
        if(canvas.state == "drawPoint") {
            if(canvas.indexPoint2D > 0) {
                canvas.indexPoint2D--;
                canvas.arrayPoint2D.pop();
            }
        }
        
        if(canvas.state == "drawSegment") {
            if(canvas.indexSegment2D > 0) {
                  if(canvas.indexSegment2D == 1) {
                    canvas.firstSegment = true;
                  }
                  canvas.indexSegment2D--;
                  canvas.arraySegment2D.pop();
            }
        }
        
        if(canvas.state == "drawCurve") {
            if(canvas.curve.size > 0) {
                canvas.curve.size--;
                canvas.curve.points.pop();
            }
        }
        
        canvas.redraw();
    }
});

//===========================================================================


$("#clearImage").click(function(e){
    if(canvas.started) {
        canvas.indexPoint2D = 0;
        canvas.arrayPoint2D = [];
        canvas.indexSegment2D = 0;
        canvas.arraySegment2D = [];
        canvas.firstSegment = true;
        canvas.curve.size = 0;
        canvas.curve.points = [];
        canvas.redraw();
    }
});

//===========================================================================

$("#buttonNewPartitionPoint").click(function(e){
  if(canvas.started) {
    var x = document.getElementById("selectedPartitionPoint");
    var option = document.createElement("option");
    canvas.sizePointsPartition++;
    var id = canvas.sizePointsPartition;
    option.value = "P"+id;
    option.text = "P"+id;
    option.selected = "selected";
    x.add(option);
    canvas.pointsPartition[id] = new Partition(id);
    canvas.currentPointPartiton = id;
  }
});

//===========================================================================

$("#buttonNewPartitionSegment").click(function(e){
  if(canvas.started) {
    var x = document.getElementById("selectedPartitionSegment");
    var option = document.createElement("option");
    canvas.sizeSegmentsPartition++;
    var id = canvas.sizeSegmentsPartition;
    option.value = "S"+id;
    option.text = "S"+id;
    option.selected = "selected";
    x.add(option);
    canvas.segmentsPartition[id] = new Partition(id);
    canvas.currentSegmentPartiton = id;
  }
});

//===========================================================================

$("#buttonNewPartitionCurve").click(function(e){
  if(canvas.started) {
    var x = document.getElementById("selectedPartitionCurve");
    var option = document.createElement("option");
    canvas.sizeCurvesPartition++;
    var id = canvas.sizeCurvesPartition;
    option.value = "C"+id;
    option.text = "C"+id;
    option.selected = "selected";
    x.add(option);
    canvas.curvesPartition[id] = new Curve2D(id);
    canvas.currentCurvePartiton = id;
  }
});

//===========================================================================

$("#buttonDeletePartitionPoint").click(function(e){
  if(canvas.started) {
    var conceptName = $('#selectedPartitionPoint').find(":selected").text();
    var option = "#selectedPartitionPoint option[value='"+conceptName+"']";
    $(option).remove();
    var id = conceptName.substring(1);
    var collectionPoint = [];
    var j = 0;
    for (var i = 0; i < canvas.pointsPartition.length; i++) {
      var partition = canvas.pointsPartition[i];
      if(partition.id != id) {
        collectionPoint[j] = partition;
        j++;
      }
    }
    canvas.pointsPartition = collectionPoint;
    if(canvas.pointsPartition.length > 0) {
      //cad l'identifiant de la 1er partition
      canvas.currentPointPartiton = canvas.pointsPartition[0].id;
    } else {
      canvas.currentPointPartiton = null;
    }
    
  }
});

//===========================================================================

$("#buttonDeletePartitionSegment").click(function(e){
  if(canvas.started) {
    var conceptName = $('#selectedPartitionSegment').find(":selected").text();
    var option = "#selectedPartitionSegment option[value='"+conceptName+"']";
    $(option).remove();
    var id = conceptName.substring(1);
    var collectionSegment = [];
    var j = 0;
    for (var i = 0; i < canvas.segmentsPartition.length; i++) {
      var partition = canvas.segmentsPartition[i];
      if(partition.id != id) {
        segmentsPartition[j] = partition;
        j++;
      }
    }
    canvas.segmentsPartition = collectionSegment;
    if(canvas.segmentsPartition.length > 0) {
      //cad l'identifiant de la 1er partition
      canvas.currentSegmentPartiton = canvas.segmentsPartition[0].id;
    } else {
      canvas.currentSegmentPartiton = null;
    }
  }
});

//===========================================================================

$("#buttonDeletePartitionCurve").click(function(e){
  if(canvas.started) {
    var conceptName = $('#selectedPartitionCurve').find(":selected").text();
    var option = "#selectedPartitionCurve option[value='"+conceptName+"']";
    $(option).remove();
    var id = conceptName.substring(1);
    var collectionCurve = [];
    var j = 0;
    for (var i = 0; i < canvas.curvesPartition.length; i++) {
      var partition = canvas.curvesPartition[i];
      if(partition.id != id) {
        collectionCurve[j] = partition;
        j++;
      }
    }
    canvas.curvesPartition = collectionCurve;
    if(canvas.curvesPartition.length > 0) {
      //cad l'identifiant de la 1er partition
      canvas.currentCurvePartiton = canvas.curvesPartition[0].id;
    } else {
      canvas.currentCurvePartiton = null;
    }
  }
});

//===========================================================================

$( "#selectedPartitionPoint" ).change(function() {
    var conceptName = $('#selectedPartitionPoint').find(":selected").text();
    var id = conceptName.substring(1);
    canvas.currentPointPartiton = id;
});

//===========================================================================

$( "#selectedPartitionSegment" ).change(function() {
    var conceptName = $('#selectedPartitionSegment').find(":selected").text();
    var id = conceptName.substring(1);
    canvas.currentSegmentPartiton = id;
});

//===========================================================================

$( "#selectedPartitionCurve" ).change(function() {
    var conceptName = $('#selectedPartitionCurve').find(":selected").text();
    var id = conceptName.substring(1);
    canvas.currentCurvePartiton = id;
});

//===========================================================================

function trackTransforms(ctx){
      var svg = document.createElementNS("http://www.w3.org/2000/svg",'svg');
      var xform = svg.createSVGMatrix();
      ctx.getTransform = function(){ return xform; };

      var savedTransforms = [];
      var save = ctx.save;
      ctx.save = function(){
          savedTransforms.push(xform.translate(0,0));
          return save.call(ctx);
      };
    
      var restore = ctx.restore;
      ctx.restore = function(){
        xform = savedTransforms.pop();
        return restore.call(ctx);
		      };

      var scale = ctx.scale;
      ctx.scale = function(sx,sy){
        xform = xform.scaleNonUniform(sx,sy);
        return scale.call(ctx,sx,sy);
		      };
    
      var rotate = ctx.rotate;
      ctx.rotate = function(radians){
          xform = xform.rotate(radians*180/Math.PI);
          return rotate.call(ctx,radians);
      };
    
      var translate = ctx.translate;
      ctx.translate = function(dx,dy){
          xform = xform.translate(dx,dy);
          return translate.call(ctx,dx,dy);
      };
    
      var transform = ctx.transform;
      ctx.transform = function(a,b,c,d,e,f){
          var m2 = svg.createSVGMatrix();
          m2.a=a; m2.b=b; m2.c=c; m2.d=d; m2.e=e; m2.f=f;
          xform = xform.multiply(m2);
          return transform.call(ctx,a,b,c,d,e,f);
      };
    
      var setTransform = ctx.setTransform;
      ctx.setTransform = function(a,b,c,d,e,f){
          xform.a = a;
          xform.b = b;
          xform.c = c;
          xform.d = d;
          xform.e = e;
          xform.f = f;
          return setTransform.call(ctx,a,b,c,d,e,f);
      };
    
      var pt  = svg.createSVGPoint();
      ctx.transformedPoint = function(x,y){
          pt.x=x; pt.y=y;
          return pt.matrixTransform(xform.inverse());
      }
}

}

//===========================================================================

canvas.loadCanvas = function (dataimage) {
  
  this.idPoint = 0;
  this.indexSegment2D = 0;
  
  //points
  
  this.indexPoint2D = dataimage.result.MultiPoint.length;
  for (var i = 0; i < this.indexPoint2D; i++) {
      var p = dataimage.result.MultiPoint[i];
      var point = new Point2D(this.idPoint, p[0], p[1]);
      this.idPoint += 1;
      this.arrayPoint2D.push(point);
  }
  
  //segments
  
  var MultiLineString = dataimage.result.MultiLineString;
  for (var i = 0; i < MultiLineString.length; i++) {
     var currentMLS = MultiLineString[i];
  
     if(currentMLS.length == 1) { //alors segment
        var tmpPointsSegment = currentMLS[0];
        var tmp2PointsSegment = [];
        
        for (var j = 0; j < tmpPointsSegment.length; j++) {
              var p = tmpPointsSegment[j];
              var point = new Point2D(this.idPoint, p[0], p[1]);
              this.idPoint += 1;
              tmp2PointsSegment.push(point);
        }
          this.firstSegment = true;
  
          if(tmpPointsSegment.length > 2) {
            this.firstSegment = false;
          }
          
          for (var j = 0; j < tmpPointsSegment.length-1; j++) {
            var p1 = tmp2PointsSegment[j];
            var p2 = tmp2PointsSegment[j+1];
            var segment = new Segment2D(this.indexSegment2D, p1, p2);
            this.arraySegment2D.push(segment);
            this.indexSegment2D += 1;
          }
  
     } else { //sinon curve
         this.curve.size = currentMLS[0].length;
         this.typeofcurve = "open";
  
          for (var j = 0; j <  this.curve.size; j++) {
            var p = currentMLS[0][j];
            var point = new Point2D(this.idPoint, p[0], p[1]);
            this.curve.points.push(point);
            this.idPoint += 1;
          }
     }
  }
  
  var MultiPolygon = dataimage.result.MultiPolygon;
  for (var i = 0; i < MultiPolygon.length; i++) {
         var currentMLS = MultiPolygon[i];
  
     if(currentMLS.length == 1) { //alors segment
        var tmpPointsSegment = currentMLS[0];
        var tmp2PointsSegment = [];
        
        for (var j = 0; j < tmpPointsSegment.length; j++) {
              var p = tmpPointsSegment[j];
              var point = new Point2D(this.idPoint, p[0], p[1]);
              this.idPoint += 1;
              tmp2PointsSegment.push(point);
        }
        
          this.firstSegment = true;
  
          if(tmpPointsSegment.length > 2) {
            this.firstSegment = false;
          }
          
          for (var j = 0; j < tmpPointsSegment.length-1; j++) {
            var p1 = tmp2PointsSegment[j];
            var p2 = tmp2PointsSegment[j+1];
            
            if(j == tmpPointsSegment.length-2) {
              if(p1.x == p2.x) {
                 if(p1.y == p2.y) {
                   p2 = tmp2PointsSegment[0];
                 }
              }
            }
            
            var segment = new Segment2D(this.indexSegment2D, p1, p2);
            this.arraySegment2D.push(segment);
            this.indexSegment2D += 1;
          }
  
     } else { //sinon curve
         this.curve.size = currentMLS[0].length;
         this.typeofcurve = "close";
  
          for (var j = 0; j <  this.curve.size; j++) {
            var p = currentMLS[0][j];
            var point = new Point2D(this.idPoint, p[0], p[1]);
            this.curve.points.push(point);
            this.idPoint += 1;
          }
     }
    
  }
  
  this.redraw();
}

//===========================================================================

function drawImage(path) {
    var p1 = ctx.transformedPoint(0,0);
    var p2 = ctx.transformedPoint(canvas.width,canvas.height);
    ctx.clearRect(p1.x,p1.y,p2.x-p1.x,p2.y-p1.y);
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.restore();
    ima1 = new Image;
    ima1.onload = function () {
        ctx.drawImage(ima1,0,0);
    };
    ima1.src = path;
}

//===========================================================================

/**
 * Object Point2D  
 **/
var Point2D = function (id, x,y) {
  this.id = id;
  this.x = x;
  this.y = y;
}

//===========================================================================

/**
 * Object Segment2D
 **/
var Segment2D = function (id, p1, p2) {
  this.id = id;
  this.p1 = p1;
  this.p2 = p2;
}

//===========================================================================

var Curve2D = function (id) {
   this.id = id;
   this.size = 0;
   this.points = [];
   this.allpts = null;
}

//===========================================================================

var Partition = function (id) {
   this.id = id;
   this.size = 0;
   this.content = [];
}

//===========================================================================

$(document).keypress(function(e){
 
        var key = e.originalEvent.key;
      
        if(key == "p") {
            actionChangeMode("drawPoint");
        } else if(key == "m") {
            actionChangeMode("move");
        } else if (key == "s") {
            actionChangeMode("drawSegment");
        } else if (key == "c") {
            actionChangeMode("drawCurve");
        } else if (canvas.started && key == "r") {
              canvas.indexPoint2D = 0;
              canvas.arrayPoint2D = [];
              canvas.indexSegment2D = 0;
              canvas.arraySegment2D = [];
              canvas.firstSegment = true;
              canvas.curve.size = 0;
              canvas.curve.points = [];
              canvas.redraw();
        } else {
          
        }
});

  </script>